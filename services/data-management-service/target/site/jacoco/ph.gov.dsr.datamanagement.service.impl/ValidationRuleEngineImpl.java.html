<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidationRuleEngineImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DSR Data Management Service</a> &gt; <a href="index.source.html" class="el_package">ph.gov.dsr.datamanagement.service.impl</a> &gt; <span class="el_source">ValidationRuleEngineImpl.java</span></div><h1>ValidationRuleEngineImpl.java</h1><pre class="source lang-java linenums">package ph.gov.dsr.datamanagement.service.impl;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Service;
import jakarta.annotation.PostConstruct;
import ph.gov.dsr.datamanagement.service.ValidationRuleEngine;
import ph.gov.dsr.datamanagement.service.impl.DataValidationServiceImpl.ValidationRule;
import ph.gov.dsr.datamanagement.service.impl.DataValidationServiceImpl.ValidationResult;


import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.*;
import java.util.regex.Pattern;

/**
 * Production implementation of ValidationRuleEngine
 * 
 * @author DSR Development Team
 * @version 3.0.0
 * @since 2024-12-23
 */
@Service
@Profile(&quot;!no-db&quot;)
<span class="nc" id="L27">@RequiredArgsConstructor</span>
<span class="nc" id="L28">@Slf4j</span>
public class ValidationRuleEngineImpl implements ValidationRuleEngine {

    // In-memory rule storage (in production, this would be database-backed)
<span class="nc" id="L32">    private final Map&lt;String, List&lt;ValidationRule&gt;&gt; rulesByDataType = new HashMap&lt;&gt;();</span>
<span class="nc" id="L33">    private final Map&lt;String, Set&lt;String&gt;&gt; profileRules = new HashMap&lt;&gt;();</span>
    
    // Common validation patterns
<span class="nc" id="L36">    private static final Pattern PSN_PATTERN = Pattern.compile(&quot;\\d{4}-\\d{4}-\\d{4}&quot;);</span>
<span class="nc" id="L37">    private static final Pattern PHONE_PATTERN = Pattern.compile(&quot;^(\\+63|0)\\d{10}$&quot;);</span>
<span class="nc" id="L38">    private static final Pattern EMAIL_PATTERN = Pattern.compile(&quot;^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$&quot;);</span>
    
    @PostConstruct
    public void initializeRules() {
<span class="nc" id="L42">        initializeDefaultRules();</span>
<span class="nc" id="L43">    }</span>

    @Override
    public List&lt;ValidationRule&gt; getRulesForDataType(String dataType, String validationProfile) {
<span class="nc" id="L47">        log.debug(&quot;Getting rules for data type: {} with profile: {}&quot;, dataType, validationProfile);</span>
        
<span class="nc" id="L49">        List&lt;ValidationRule&gt; allRules = rulesByDataType.getOrDefault(dataType, new ArrayList&lt;&gt;());</span>
        
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (&quot;DEFAULT&quot;.equals(validationProfile)) {</span>
<span class="nc" id="L52">            return allRules.stream()</span>
<span class="nc" id="L53">                    .filter(ValidationRule::isEnabled)</span>
<span class="nc" id="L54">                    .collect(java.util.stream.Collectors.toList());</span>
        }

        // Filter rules by profile
<span class="nc" id="L58">        Set&lt;String&gt; profileRuleNames = profileRules.getOrDefault(validationProfile, new HashSet&lt;&gt;());</span>
<span class="nc" id="L59">        return allRules.stream()</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">                .filter(rule -&gt; rule.isEnabled() &amp;&amp; profileRuleNames.contains(rule.getName()))</span>
<span class="nc" id="L61">                .collect(java.util.stream.Collectors.toList());</span>
    }

    @Override
    public List&lt;String&gt; getRuleNamesForDataType(String dataType) {
<span class="nc" id="L66">        log.debug(&quot;Getting rule names for data type: {}&quot;, dataType);</span>
        
<span class="nc" id="L68">        return rulesByDataType.getOrDefault(dataType, new ArrayList&lt;&gt;())</span>
<span class="nc" id="L69">                .stream()</span>
<span class="nc" id="L70">                .map(ValidationRule::getName)</span>
<span class="nc" id="L71">                .collect(java.util.stream.Collectors.toList());</span>
    }

    @Override
    public ValidationResult applyRule(ValidationRule rule, Map&lt;String, Object&gt; data) {
<span class="nc" id="L76">        log.debug(&quot;Applying rule: {} to field: {}&quot;, rule.getName(), rule.getField());</span>
        
<span class="nc" id="L78">        ValidationResult result = new ValidationResult();</span>
<span class="nc" id="L79">        result.setField(rule.getField());</span>
        
        try {
<span class="nc" id="L82">            Object fieldValue = data.get(rule.getField());</span>
            
            // Apply rule based on expression type
<span class="nc bnc" id="L85" title="All 10 branches missed.">            switch (rule.getExpression()) {</span>
                case &quot;REQUIRED&quot;:
<span class="nc" id="L87">                    result = validateRequired(fieldValue, rule);</span>
<span class="nc" id="L88">                    break;</span>
                case &quot;PSN_FORMAT&quot;:
<span class="nc" id="L90">                    result = validatePSNFormat(fieldValue, rule);</span>
<span class="nc" id="L91">                    break;</span>
                case &quot;PHONE_FORMAT&quot;:
<span class="nc" id="L93">                    result = validatePhoneFormat(fieldValue, rule);</span>
<span class="nc" id="L94">                    break;</span>
                case &quot;EMAIL_FORMAT&quot;:
<span class="nc" id="L96">                    result = validateEmailFormat(fieldValue, rule);</span>
<span class="nc" id="L97">                    break;</span>
                case &quot;DATE_VALID&quot;:
<span class="nc" id="L99">                    result = validateDateFormat(fieldValue, rule);</span>
<span class="nc" id="L100">                    break;</span>
                case &quot;POSITIVE_NUMBER&quot;:
<span class="nc" id="L102">                    result = validatePositiveNumber(fieldValue, rule);</span>
<span class="nc" id="L103">                    break;</span>
                case &quot;NON_NEGATIVE&quot;:
<span class="nc" id="L105">                    result = validateNonNegative(fieldValue, rule);</span>
<span class="nc" id="L106">                    break;</span>
                case &quot;SEX_VALID&quot;:
<span class="nc" id="L108">                    result = validateSex(fieldValue, rule);</span>
<span class="nc" id="L109">                    break;</span>
                case &quot;CIVIL_STATUS_VALID&quot;:
<span class="nc" id="L111">                    result = validateCivilStatus(fieldValue, rule);</span>
<span class="nc" id="L112">                    break;</span>
                default:
                    // Custom expression evaluation
<span class="nc" id="L115">                    result = evaluateCustomExpression(rule.getExpression(), fieldValue, data, rule);</span>
            }
            
<span class="nc" id="L118">            result.setField(rule.getField());</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (!result.isValid()) {</span>
<span class="nc" id="L120">                result.setErrorCode(rule.getName());</span>
<span class="nc" id="L121">                result.setErrorMessage(rule.getErrorMessage());</span>
<span class="nc" id="L122">                result.setSeverity(rule.getSeverity());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                result.setRejectedValue(fieldValue != null ? fieldValue.toString() : null);</span>
            }
            
<span class="nc" id="L126">        } catch (Exception e) {</span>
<span class="nc" id="L127">            log.error(&quot;Error applying validation rule: {}&quot;, rule.getName(), e);</span>
<span class="nc" id="L128">            result.setValid(false);</span>
<span class="nc" id="L129">            result.setErrorCode(&quot;RULE_ERROR&quot;);</span>
<span class="nc" id="L130">            result.setErrorMessage(&quot;Error applying validation rule: &quot; + e.getMessage());</span>
<span class="nc" id="L131">            result.setSeverity(&quot;ERROR&quot;);</span>
<span class="nc" id="L132">        }</span>
        
<span class="nc" id="L134">        return result;</span>
    }

    @Override
    public void addRule(String dataType, String ruleName, String ruleExpression) {
<span class="nc" id="L139">        log.info(&quot;Adding rule '{}' for data type: {}&quot;, ruleName, dataType);</span>
        
<span class="nc" id="L141">        ValidationRule rule = new ValidationRule();</span>
<span class="nc" id="L142">        rule.setName(ruleName);</span>
<span class="nc" id="L143">        rule.setDataType(dataType);</span>
<span class="nc" id="L144">        rule.setExpression(ruleExpression);</span>
<span class="nc" id="L145">        rule.setEnabled(true);</span>
<span class="nc" id="L146">        rule.setSeverity(&quot;ERROR&quot;);</span>
        
<span class="nc" id="L148">        rulesByDataType.computeIfAbsent(dataType, k -&gt; new ArrayList&lt;&gt;()).add(rule);</span>
<span class="nc" id="L149">    }</span>

    @Override
    public void removeRule(String dataType, String ruleName) {
<span class="nc" id="L153">        log.info(&quot;Removing rule '{}' for data type: {}&quot;, ruleName, dataType);</span>
        
<span class="nc" id="L155">        List&lt;ValidationRule&gt; rules = rulesByDataType.get(dataType);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L157">            rules.removeIf(rule -&gt; rule.getName().equals(ruleName));</span>
        }
<span class="nc" id="L159">    }</span>

    @Override
    public void updateRule(String dataType, String ruleName, String ruleExpression) {
<span class="nc" id="L163">        log.info(&quot;Updating rule '{}' for data type: {}&quot;, ruleName, dataType);</span>
        
<span class="nc" id="L165">        List&lt;ValidationRule&gt; rules = rulesByDataType.get(dataType);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L167">            rules.stream()</span>
<span class="nc" id="L168">                    .filter(rule -&gt; rule.getName().equals(ruleName))</span>
<span class="nc" id="L169">                    .findFirst()</span>
<span class="nc" id="L170">                    .ifPresent(rule -&gt; rule.setExpression(ruleExpression));</span>
        }
<span class="nc" id="L172">    }</span>

    @Override
    public void setRuleEnabled(String dataType, String ruleName, boolean enabled) {
<span class="nc" id="L176">        log.info(&quot;Setting rule '{}' enabled={} for data type: {}&quot;, ruleName, enabled, dataType);</span>
        
<span class="nc" id="L178">        List&lt;ValidationRule&gt; rules = rulesByDataType.get(dataType);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L180">            rules.stream()</span>
<span class="nc" id="L181">                    .filter(rule -&gt; rule.getName().equals(ruleName))</span>
<span class="nc" id="L182">                    .findFirst()</span>
<span class="nc" id="L183">                    .ifPresent(rule -&gt; rule.setEnabled(enabled));</span>
        }
<span class="nc" id="L185">    }</span>

    @Override
    public ValidationResult testRule(String ruleExpression, Map&lt;String, Object&gt; testData) {
<span class="nc" id="L189">        log.debug(&quot;Testing rule expression: {}&quot;, ruleExpression);</span>
        
<span class="nc" id="L191">        ValidationRule testRule = new ValidationRule();</span>
<span class="nc" id="L192">        testRule.setName(&quot;TEST_RULE&quot;);</span>
<span class="nc" id="L193">        testRule.setExpression(ruleExpression);</span>
<span class="nc" id="L194">        testRule.setField(&quot;testField&quot;);</span>
<span class="nc" id="L195">        testRule.setErrorMessage(&quot;Test rule failed&quot;);</span>
<span class="nc" id="L196">        testRule.setSeverity(&quot;ERROR&quot;);</span>
        
<span class="nc" id="L198">        return applyRule(testRule, testData);</span>
    }

    @Override
    public List&lt;String&gt; getValidationProfiles() {
<span class="nc" id="L203">        return new ArrayList&lt;&gt;(profileRules.keySet());</span>
    }

    @Override
    public void createValidationProfile(String profileName, String description) {
<span class="nc" id="L208">        log.info(&quot;Creating validation profile: {}&quot;, profileName);</span>
<span class="nc" id="L209">        profileRules.put(profileName, new HashSet&lt;&gt;());</span>
<span class="nc" id="L210">    }</span>

    @Override
    public void assignRuleToProfile(String dataType, String ruleName, String profileName) {
<span class="nc" id="L214">        log.info(&quot;Assigning rule '{}' to profile: {}&quot;, ruleName, profileName);</span>
<span class="nc" id="L215">        profileRules.computeIfAbsent(profileName, k -&gt; new HashSet&lt;&gt;()).add(ruleName);</span>
<span class="nc" id="L216">    }</span>

    @Override
    public void removeRuleFromProfile(String dataType, String ruleName, String profileName) {
<span class="nc" id="L220">        log.info(&quot;Removing rule '{}' from profile: {}&quot;, ruleName, profileName);</span>
<span class="nc" id="L221">        Set&lt;String&gt; rules = profileRules.get(profileName);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (rules != null) {</span>
<span class="nc" id="L223">            rules.remove(ruleName);</span>
        }
<span class="nc" id="L225">    }</span>
    
    /**
     * Initialize default validation rules
     */
    private void initializeDefaultRules() {
        // Household validation rules
<span class="nc" id="L232">        addDefaultRule(&quot;HOUSEHOLD&quot;, &quot;household_number_required&quot;, &quot;REQUIRED&quot;, &quot;householdNumber&quot;, </span>
                &quot;Household number is required&quot;);
<span class="nc" id="L234">        addDefaultRule(&quot;HOUSEHOLD&quot;, &quot;head_psn_format&quot;, &quot;PSN_FORMAT&quot;, &quot;headOfHouseholdPSN&quot;, </span>
                &quot;Head of household PSN must be in format XXXX-XXXX-XXXX&quot;);
<span class="nc" id="L236">        addDefaultRule(&quot;HOUSEHOLD&quot;, &quot;total_members_positive&quot;, &quot;POSITIVE_NUMBER&quot;, &quot;totalMembers&quot;, </span>
                &quot;Total members must be a positive number&quot;);
<span class="nc" id="L238">        addDefaultRule(&quot;HOUSEHOLD&quot;, &quot;monthly_income_non_negative&quot;, &quot;NON_NEGATIVE&quot;, &quot;monthlyIncome&quot;, </span>
                &quot;Monthly income must be non-negative&quot;);
        
        // Individual validation rules
<span class="nc" id="L242">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;psn_required&quot;, &quot;REQUIRED&quot;, &quot;psn&quot;, </span>
                &quot;PSN is required&quot;);
<span class="nc" id="L244">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;psn_format&quot;, &quot;PSN_FORMAT&quot;, &quot;psn&quot;, </span>
                &quot;PSN must be in format XXXX-XXXX-XXXX&quot;);
<span class="nc" id="L246">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;first_name_required&quot;, &quot;REQUIRED&quot;, &quot;firstName&quot;, </span>
                &quot;First name is required&quot;);
<span class="nc" id="L248">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;last_name_required&quot;, &quot;REQUIRED&quot;, &quot;lastName&quot;, </span>
                &quot;Last name is required&quot;);
<span class="nc" id="L250">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;date_of_birth_valid&quot;, &quot;DATE_VALID&quot;, &quot;dateOfBirth&quot;, </span>
                &quot;Date of birth must be a valid date&quot;);
<span class="nc" id="L252">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;sex_valid&quot;, &quot;SEX_VALID&quot;, &quot;sex&quot;, </span>
                &quot;Sex must be M or F&quot;);
<span class="nc" id="L254">        addDefaultRule(&quot;INDIVIDUAL&quot;, &quot;civil_status_valid&quot;, &quot;CIVIL_STATUS_VALID&quot;, &quot;civilStatus&quot;, </span>
                &quot;Civil status must be valid&quot;);
        
        // Economic Profile validation rules
<span class="nc" id="L258">        addDefaultRule(&quot;ECONOMIC_PROFILE&quot;, &quot;household_id_required&quot;, &quot;REQUIRED&quot;, &quot;householdId&quot;, </span>
                &quot;Household ID is required&quot;);
<span class="nc" id="L260">        addDefaultRule(&quot;ECONOMIC_PROFILE&quot;, &quot;assets_non_negative&quot;, &quot;NON_NEGATIVE&quot;, &quot;totalAssets&quot;, </span>
                &quot;Total assets must be non-negative&quot;);
<span class="nc" id="L262">        addDefaultRule(&quot;ECONOMIC_PROFILE&quot;, &quot;expenses_non_negative&quot;, &quot;NON_NEGATIVE&quot;, &quot;monthlyExpenses&quot;, </span>
                &quot;Monthly expenses must be non-negative&quot;);
<span class="nc" id="L264">    }</span>
    
    private void addDefaultRule(String dataType, String ruleName, String expression, String field, String errorMessage) {
<span class="nc" id="L267">        ValidationRule rule = new ValidationRule();</span>
<span class="nc" id="L268">        rule.setName(ruleName);</span>
<span class="nc" id="L269">        rule.setDataType(dataType);</span>
<span class="nc" id="L270">        rule.setExpression(expression);</span>
<span class="nc" id="L271">        rule.setField(field);</span>
<span class="nc" id="L272">        rule.setErrorMessage(errorMessage);</span>
<span class="nc" id="L273">        rule.setSeverity(&quot;ERROR&quot;);</span>
<span class="nc" id="L274">        rule.setEnabled(true);</span>
        
<span class="nc" id="L276">        rulesByDataType.computeIfAbsent(dataType, k -&gt; new ArrayList&lt;&gt;()).add(rule);</span>
<span class="nc" id="L277">    }</span>
    
    // Validation methods
    private ValidationResult validateRequired(Object value, ValidationRule rule) {
<span class="nc" id="L281">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">        result.setValid(value != null &amp;&amp; !value.toString().trim().isEmpty());</span>
<span class="nc" id="L283">        return result;</span>
    }
    
    private ValidationResult validatePSNFormat(Object value, ValidationRule rule) {
<span class="nc" id="L287">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L289">            result.setValid(true); // Let REQUIRED rule handle null values</span>
<span class="nc" id="L290">            return result;</span>
        }
        
<span class="nc" id="L293">        String psn = value.toString().trim();</span>
<span class="nc" id="L294">        result.setValid(PSN_PATTERN.matcher(psn).matches());</span>
<span class="nc" id="L295">        return result;</span>
    }
    
    private ValidationResult validatePhoneFormat(Object value, ValidationRule rule) {
<span class="nc" id="L299">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L301">            result.setValid(true);</span>
<span class="nc" id="L302">            return result;</span>
        }
        
<span class="nc" id="L305">        String phone = value.toString().trim();</span>
<span class="nc" id="L306">        result.setValid(PHONE_PATTERN.matcher(phone).matches());</span>
<span class="nc" id="L307">        return result;</span>
    }
    
    private ValidationResult validateEmailFormat(Object value, ValidationRule rule) {
<span class="nc" id="L311">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L313">            result.setValid(true);</span>
<span class="nc" id="L314">            return result;</span>
        }
        
<span class="nc" id="L317">        String email = value.toString().trim();</span>
<span class="nc" id="L318">        result.setValid(EMAIL_PATTERN.matcher(email).matches());</span>
<span class="nc" id="L319">        return result;</span>
    }
    
    private ValidationResult validateDateFormat(Object value, ValidationRule rule) {
<span class="nc" id="L323">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L325">            result.setValid(true);</span>
<span class="nc" id="L326">            return result;</span>
        }
        
        try {
<span class="nc" id="L330">            LocalDate.parse(value.toString());</span>
<span class="nc" id="L331">            result.setValid(true);</span>
<span class="nc" id="L332">        } catch (DateTimeParseException e) {</span>
<span class="nc" id="L333">            result.setValid(false);</span>
<span class="nc" id="L334">        }</span>
        
<span class="nc" id="L336">        return result;</span>
    }
    
    private ValidationResult validatePositiveNumber(Object value, ValidationRule rule) {
<span class="nc" id="L340">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L342">            result.setValid(true);</span>
<span class="nc" id="L343">            return result;</span>
        }
        
        try {
<span class="nc" id="L347">            double num = Double.parseDouble(value.toString());</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            result.setValid(num &gt; 0);</span>
<span class="nc" id="L349">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L350">            result.setValid(false);</span>
<span class="nc" id="L351">        }</span>
        
<span class="nc" id="L353">        return result;</span>
    }
    
    private ValidationResult validateNonNegative(Object value, ValidationRule rule) {
<span class="nc" id="L357">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L359">            result.setValid(true);</span>
<span class="nc" id="L360">            return result;</span>
        }
        
        try {
<span class="nc" id="L364">            double num = Double.parseDouble(value.toString());</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            result.setValid(num &gt;= 0);</span>
<span class="nc" id="L366">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L367">            result.setValid(false);</span>
<span class="nc" id="L368">        }</span>
        
<span class="nc" id="L370">        return result;</span>
    }
    
    private ValidationResult validateSex(Object value, ValidationRule rule) {
<span class="nc" id="L374">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L376">            result.setValid(true);</span>
<span class="nc" id="L377">            return result;</span>
        }
        
<span class="nc" id="L380">        String sex = value.toString().trim().toUpperCase();</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">        result.setValid(&quot;M&quot;.equals(sex) || &quot;F&quot;.equals(sex));</span>
<span class="nc" id="L382">        return result;</span>
    }
    
    private ValidationResult validateCivilStatus(Object value, ValidationRule rule) {
<span class="nc" id="L386">        ValidationResult result = new ValidationResult();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L388">            result.setValid(true);</span>
<span class="nc" id="L389">            return result;</span>
        }
        
<span class="nc" id="L392">        String status = value.toString().trim().toUpperCase();</span>
<span class="nc" id="L393">        Set&lt;String&gt; validStatuses = Set.of(&quot;SINGLE&quot;, &quot;MARRIED&quot;, &quot;WIDOWED&quot;, &quot;DIVORCED&quot;, &quot;SEPARATED&quot;);</span>
<span class="nc" id="L394">        result.setValid(validStatuses.contains(status));</span>
<span class="nc" id="L395">        return result;</span>
    }
    
    private ValidationResult evaluateCustomExpression(String expression, Object fieldValue, 
                                                    Map&lt;String, Object&gt; data, ValidationRule rule) {
<span class="nc" id="L400">        ValidationResult result = new ValidationResult();</span>
        
        // TODO: Implement custom expression evaluation
        // This could use a scripting engine like JavaScript or a custom DSL
        // For now, return valid
<span class="nc" id="L405">        result.setValid(true);</span>
        
<span class="nc" id="L407">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>