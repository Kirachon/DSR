<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataValidationServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DSR Data Management Service</a> &gt; <a href="index.source.html" class="el_package">ph.gov.dsr.datamanagement.service.impl</a> &gt; <span class="el_source">DataValidationServiceImpl.java</span></div><h1>DataValidationServiceImpl.java</h1><pre class="source lang-java linenums">package ph.gov.dsr.datamanagement.service.impl;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Service;
import ph.gov.dsr.datamanagement.dto.ValidationRequest;
import ph.gov.dsr.datamanagement.dto.ValidationResponse;
import ph.gov.dsr.datamanagement.service.DataValidationService;
import ph.gov.dsr.datamanagement.service.ValidationRuleEngine;
import ph.gov.dsr.datamanagement.service.DataCleaningService;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Production implementation of DataValidationService
 * 
 * @author DSR Development Team
 * @version 3.0.0
 * @since 2024-12-23
 */
@Service
@Profile(&quot;!no-db&quot;)
<span class="nc" id="L28">@RequiredArgsConstructor</span>
<span class="nc" id="L29">@Slf4j</span>
public class DataValidationServiceImpl implements DataValidationService {

    private final ValidationRuleEngine validationRuleEngine;
    private final DataCleaningService dataCleaningService;

    @Override
    public ValidationResponse validateData(ValidationRequest request) {
<span class="nc" id="L37">        log.info(&quot;Validating data of type: {} with profile: {}&quot;, request.getDataType(), request.getValidationProfile());</span>
<span class="nc" id="L38">        long startTime = System.currentTimeMillis();</span>
        
<span class="nc" id="L40">        ValidationResponse response = new ValidationResponse();</span>
<span class="nc" id="L41">        response.setValidatedAt(LocalDateTime.now());</span>
<span class="nc" id="L42">        response.setValidationProfile(request.getValidationProfile());</span>
<span class="nc" id="L43">        response.setErrors(new ArrayList&lt;&gt;());</span>
<span class="nc" id="L44">        response.setWarnings(new ArrayList&lt;&gt;());</span>
        
        try {
            // Get validation rules for the data type and profile
<span class="nc" id="L48">            List&lt;ValidationRule&gt; rules = validationRuleEngine.getRulesForDataType(</span>
<span class="nc" id="L49">                request.getDataType(), request.getValidationProfile());</span>
            
<span class="nc" id="L51">            boolean isValid = true;</span>
            
            // Apply each validation rule
<span class="nc bnc" id="L54" title="All 2 branches missed.">            for (ValidationRule rule : rules) {</span>
<span class="nc" id="L55">                ValidationResult result = validationRuleEngine.applyRule(rule, request.getData());</span>
                
<span class="nc bnc" id="L57" title="All 2 branches missed.">                if (!result.isValid()) {</span>
<span class="nc" id="L58">                    isValid = false;</span>
                    
<span class="nc" id="L60">                    ValidationResponse.ValidationError error = new ValidationResponse.ValidationError();</span>
<span class="nc" id="L61">                    error.setField(result.getField());</span>
<span class="nc" id="L62">                    error.setCode(result.getErrorCode());</span>
<span class="nc" id="L63">                    error.setMessage(result.getErrorMessage());</span>
<span class="nc" id="L64">                    error.setRejectedValue(result.getRejectedValue());</span>
<span class="nc" id="L65">                    error.setSeverity(result.getSeverity());</span>
                    
<span class="nc" id="L67">                    response.getErrors().add(error);</span>
                }
                
                // Add warnings if any
<span class="nc bnc" id="L71" title="All 4 branches missed.">                if (request.isIncludeWarnings() &amp;&amp; result.hasWarnings()) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                    for (ValidationWarning warning : result.getWarnings()) {</span>
<span class="nc" id="L73">                        ValidationResponse.ValidationWarning responseWarning = </span>
                            new ValidationResponse.ValidationWarning();
<span class="nc" id="L75">                        responseWarning.setField(warning.getField());</span>
<span class="nc" id="L76">                        responseWarning.setCode(warning.getCode());</span>
<span class="nc" id="L77">                        responseWarning.setMessage(warning.getMessage());</span>
<span class="nc" id="L78">                        responseWarning.setSuggestion(warning.getSuggestion());</span>
                        
<span class="nc" id="L80">                        response.getWarnings().add(responseWarning);</span>
<span class="nc" id="L81">                    }</span>
                }
<span class="nc" id="L83">            }</span>
            
            // Validate references if requested
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (request.isValidateReferences()) {</span>
<span class="nc" id="L87">                ValidationResult referenceResult = validateReferences(request.getDataType(), request.getData());</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (!referenceResult.isValid()) {</span>
<span class="nc" id="L89">                    isValid = false;</span>
                    
<span class="nc" id="L91">                    ValidationResponse.ValidationError error = new ValidationResponse.ValidationError();</span>
<span class="nc" id="L92">                    error.setField(referenceResult.getField());</span>
<span class="nc" id="L93">                    error.setCode(referenceResult.getErrorCode());</span>
<span class="nc" id="L94">                    error.setMessage(referenceResult.getErrorMessage());</span>
<span class="nc" id="L95">                    error.setRejectedValue(referenceResult.getRejectedValue());</span>
<span class="nc" id="L96">                    error.setSeverity(&quot;ERROR&quot;);</span>
                    
<span class="nc" id="L98">                    response.getErrors().add(error);</span>
                }
            }
            
<span class="nc" id="L102">            response.setValid(isValid);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            response.setStatus(isValid ? &quot;VALID&quot; : &quot;INVALID&quot;);</span>
            
            // Add overall status based on errors and warnings
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (!isValid) {</span>
<span class="nc" id="L107">                response.setStatus(&quot;INVALID&quot;);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            } else if (!response.getWarnings().isEmpty()) {</span>
<span class="nc" id="L109">                response.setStatus(&quot;WARNING&quot;);</span>
            } else {
<span class="nc" id="L111">                response.setStatus(&quot;VALID&quot;);</span>
            }
            
<span class="nc" id="L114">        } catch (Exception e) {</span>
<span class="nc" id="L115">            log.error(&quot;Error during data validation&quot;, e);</span>
<span class="nc" id="L116">            response.setValid(false);</span>
<span class="nc" id="L117">            response.setStatus(&quot;ERROR&quot;);</span>
            
<span class="nc" id="L119">            ValidationResponse.ValidationError error = new ValidationResponse.ValidationError();</span>
<span class="nc" id="L120">            error.setField(&quot;SYSTEM&quot;);</span>
<span class="nc" id="L121">            error.setCode(&quot;VALIDATION_ERROR&quot;);</span>
<span class="nc" id="L122">            error.setMessage(&quot;Internal validation error: &quot; + e.getMessage());</span>
<span class="nc" id="L123">            error.setSeverity(&quot;ERROR&quot;);</span>
            
<span class="nc" id="L125">            response.getErrors().add(error);</span>
<span class="nc" id="L126">        }</span>
        
<span class="nc" id="L128">        response.setValidationTimeMs(System.currentTimeMillis() - startTime);</span>
        
<span class="nc" id="L130">        log.info(&quot;Data validation completed. Status: {}, Errors: {}, Warnings: {}, Time: {}ms&quot;, </span>
<span class="nc" id="L131">                response.getStatus(), response.getErrors().size(), response.getWarnings().size(), </span>
<span class="nc" id="L132">                response.getValidationTimeMs());</span>
        
<span class="nc" id="L134">        return response;</span>
    }

    @Override
    public List&lt;ValidationResponse&gt; validateBatch(List&lt;ValidationRequest&gt; requests) {
<span class="nc" id="L139">        log.info(&quot;Validating batch of {} records&quot;, requests.size());</span>
        
<span class="nc" id="L141">        List&lt;ValidationResponse&gt; responses = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L143" title="All 2 branches missed.">        for (ValidationRequest request : requests) {</span>
<span class="nc" id="L144">            responses.add(validateData(request));</span>
<span class="nc" id="L145">        }</span>
        
<span class="nc" id="L147">        return responses;</span>
    }

    @Override
    public Map&lt;String, Object&gt; cleanData(Map&lt;String, Object&gt; data, String dataType) {
<span class="nc" id="L152">        log.info(&quot;Cleaning data of type: {}&quot;, dataType);</span>
        
        try {
<span class="nc" id="L155">            return dataCleaningService.cleanData(data, dataType);</span>
<span class="nc" id="L156">        } catch (Exception e) {</span>
<span class="nc" id="L157">            log.error(&quot;Error during data cleaning&quot;, e);</span>
            // Return original data if cleaning fails
<span class="nc" id="L159">            return new HashMap&lt;&gt;(data);</span>
        }
    }

    @Override
    public List&lt;String&gt; getValidationRules(String dataType) {
<span class="nc" id="L165">        log.info(&quot;Getting validation rules for data type: {}&quot;, dataType);</span>
        
        try {
<span class="nc" id="L168">            return validationRuleEngine.getRuleNamesForDataType(dataType);</span>
<span class="nc" id="L169">        } catch (Exception e) {</span>
<span class="nc" id="L170">            log.error(&quot;Error getting validation rules&quot;, e);</span>
<span class="nc" id="L171">            return new ArrayList&lt;&gt;();</span>
        }
    }

    @Override
    public void addValidationRule(String dataType, String ruleName, String ruleExpression) {
<span class="nc" id="L177">        log.info(&quot;Adding validation rule '{}' for data type: {}&quot;, ruleName, dataType);</span>
        
        try {
<span class="nc" id="L180">            validationRuleEngine.addRule(dataType, ruleName, ruleExpression);</span>
<span class="nc" id="L181">        } catch (Exception e) {</span>
<span class="nc" id="L182">            log.error(&quot;Error adding validation rule&quot;, e);</span>
<span class="nc" id="L183">            throw new RuntimeException(&quot;Failed to add validation rule: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">    }</span>

    @Override
    public void removeValidationRule(String dataType, String ruleName) {
<span class="nc" id="L189">        log.info(&quot;Removing validation rule '{}' for data type: {}&quot;, ruleName, dataType);</span>
        
        try {
<span class="nc" id="L192">            validationRuleEngine.removeRule(dataType, ruleName);</span>
<span class="nc" id="L193">        } catch (Exception e) {</span>
<span class="nc" id="L194">            log.error(&quot;Error removing validation rule&quot;, e);</span>
<span class="nc" id="L195">            throw new RuntimeException(&quot;Failed to remove validation rule: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L196">        }</span>
<span class="nc" id="L197">    }</span>
    
    /**
     * Validate foreign key references
     */
    private ValidationResult validateReferences(String dataType, Map&lt;String, Object&gt; data) {
<span class="nc" id="L203">        ValidationResult result = new ValidationResult();</span>
<span class="nc" id="L204">        result.setValid(true);</span>
        
        // TODO: Implement reference validation logic
        // This would check if referenced entities exist in the database
        // For example:
        // - Household references should validate PSN exists
        // - Individual references should validate household exists
        // - Economic profile references should validate household exists
        
<span class="nc" id="L213">        return result;</span>
    }
    
    // Inner classes for validation results
<span class="nc" id="L217">    public static class ValidationRule {</span>
        private String name;
        private String dataType;
        private String field;
        private String expression;
        private String errorMessage;
        private String severity;
        private boolean enabled;
        
        // Getters and setters
<span class="nc" id="L227">        public String getName() { return name; }</span>
<span class="nc" id="L228">        public void setName(String name) { this.name = name; }</span>
        
<span class="nc" id="L230">        public String getDataType() { return dataType; }</span>
<span class="nc" id="L231">        public void setDataType(String dataType) { this.dataType = dataType; }</span>
        
<span class="nc" id="L233">        public String getField() { return field; }</span>
<span class="nc" id="L234">        public void setField(String field) { this.field = field; }</span>
        
<span class="nc" id="L236">        public String getExpression() { return expression; }</span>
<span class="nc" id="L237">        public void setExpression(String expression) { this.expression = expression; }</span>
        
<span class="nc" id="L239">        public String getErrorMessage() { return errorMessage; }</span>
<span class="nc" id="L240">        public void setErrorMessage(String errorMessage) { this.errorMessage = errorMessage; }</span>
        
<span class="nc" id="L242">        public String getSeverity() { return severity; }</span>
<span class="nc" id="L243">        public void setSeverity(String severity) { this.severity = severity; }</span>
        
<span class="nc" id="L245">        public boolean isEnabled() { return enabled; }</span>
<span class="nc" id="L246">        public void setEnabled(boolean enabled) { this.enabled = enabled; }</span>
    }
    
<span class="nc" id="L249">    public static class ValidationResult {</span>
<span class="nc" id="L250">        private boolean valid = true;</span>
        private String field;
        private String errorCode;
        private String errorMessage;
        private String rejectedValue;
        private String severity;
<span class="nc" id="L256">        private List&lt;ValidationWarning&gt; warnings = new ArrayList&lt;&gt;();</span>
        
        // Getters and setters
<span class="nc" id="L259">        public boolean isValid() { return valid; }</span>
<span class="nc" id="L260">        public void setValid(boolean valid) { this.valid = valid; }</span>
        
<span class="nc" id="L262">        public String getField() { return field; }</span>
<span class="nc" id="L263">        public void setField(String field) { this.field = field; }</span>
        
<span class="nc" id="L265">        public String getErrorCode() { return errorCode; }</span>
<span class="nc" id="L266">        public void setErrorCode(String errorCode) { this.errorCode = errorCode; }</span>
        
<span class="nc" id="L268">        public String getErrorMessage() { return errorMessage; }</span>
<span class="nc" id="L269">        public void setErrorMessage(String errorMessage) { this.errorMessage = errorMessage; }</span>
        
<span class="nc" id="L271">        public String getRejectedValue() { return rejectedValue; }</span>
<span class="nc" id="L272">        public void setRejectedValue(String rejectedValue) { this.rejectedValue = rejectedValue; }</span>
        
<span class="nc" id="L274">        public String getSeverity() { return severity; }</span>
<span class="nc" id="L275">        public void setSeverity(String severity) { this.severity = severity; }</span>
        
<span class="nc" id="L277">        public List&lt;ValidationWarning&gt; getWarnings() { return warnings; }</span>
<span class="nc" id="L278">        public void setWarnings(List&lt;ValidationWarning&gt; warnings) { this.warnings = warnings; }</span>
        
<span class="nc bnc" id="L280" title="All 4 branches missed.">        public boolean hasWarnings() { return warnings != null &amp;&amp; !warnings.isEmpty(); }</span>
    }
    
<span class="nc" id="L283">    public static class ValidationWarning {</span>
        private String field;
        private String code;
        private String message;
        private String suggestion;
        
        // Getters and setters
<span class="nc" id="L290">        public String getField() { return field; }</span>
<span class="nc" id="L291">        public void setField(String field) { this.field = field; }</span>
        
<span class="nc" id="L293">        public String getCode() { return code; }</span>
<span class="nc" id="L294">        public void setCode(String code) { this.code = code; }</span>
        
<span class="nc" id="L296">        public String getMessage() { return message; }</span>
<span class="nc" id="L297">        public void setMessage(String message) { this.message = message; }</span>
        
<span class="nc" id="L299">        public String getSuggestion() { return suggestion; }</span>
<span class="nc" id="L300">        public void setSuggestion(String suggestion) { this.suggestion = suggestion; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>