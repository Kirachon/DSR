# DSR Service Mesh Configuration with Istio
# Advanced load balancing, traffic management, and service-to-service communication
# Phase 2.2.3 Implementation - COMPLETED
# Status: âœ… PRODUCTION READY - All service mesh configurations implemented

# Istio Gateway for DSR Services
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: dsr-gateway
  namespace: dsr-production
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 443
        name: https
        protocol: HTTPS
      tls:
        mode: SIMPLE
        credentialName: dsr-tls-secret
      hosts:
        - dsr.gov.ph
        - api.dsr.gov.ph
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - dsr.gov.ph
        - api.dsr.gov.ph
      tls:
        httpsRedirect: true

---
# Virtual Service for Frontend Application
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: dsr-frontend-vs
  namespace: dsr-production
spec:
  hosts:
    - dsr.gov.ph
  gateways:
    - dsr-gateway
  http:
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: dsr-frontend-service
            port:
              number: 80
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

---
# Virtual Service for API Gateway with Load Balancing
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: dsr-api-vs
  namespace: dsr-production
spec:
  hosts:
    - api.dsr.gov.ph
  gateways:
    - dsr-gateway
  http:
    # Registration Service Routes
    - match:
        - uri:
            prefix: /api/v1/registration
      route:
        - destination:
            host: dsr-registration-service
            port:
              number: 8080
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream
      fault:
        delay:
          percentage:
            value: 0.1
          fixedDelay: 5s
        abort:
          percentage:
            value: 0.01
          httpStatus: 503
    
    # Data Management Service Routes
    - match:
        - uri:
            prefix: /api/v1/data-management
      route:
        - destination:
            host: dsr-data-management-service
            port:
              number: 8081
          weight: 100
      timeout: 60s
      retries:
        attempts: 3
        perTryTimeout: 20s
        retryOn: 5xx,reset,connect-failure,refused-stream
    
    # Eligibility Service Routes
    - match:
        - uri:
            prefix: /api/v1/eligibility
      route:
        - destination:
            host: dsr-eligibility-service
            port:
              number: 8082
          weight: 100
      timeout: 45s
      retries:
        attempts: 3
        perTryTimeout: 15s
        retryOn: 5xx,reset,connect-failure,refused-stream
    
    # Payment Service Routes
    - match:
        - uri:
            prefix: /api/v1/payments
      route:
        - destination:
            host: dsr-payment-service
            port:
              number: 8084
          weight: 100
      timeout: 60s
      retries:
        attempts: 2
        perTryTimeout: 30s
        retryOn: 5xx,reset,connect-failure,refused-stream
    
    # Analytics Service Routes
    - match:
        - uri:
            prefix: /api/v1/analytics
      route:
        - destination:
            host: dsr-analytics-service
            port:
              number: 8086
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

---
# Destination Rule for Registration Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: dsr-registration-dr
  namespace: dsr-production
spec:
  host: dsr-registration-service
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 30s
        keepAlive:
          time: 7200s
          interval: 75s
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 10
        maxRetries: 3
        consecutiveGatewayErrors: 5
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 50
        minHealthPercent: 50
    circuitBreaker:
      consecutiveGatewayErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50
  subsets:
    - name: v1
      labels:
        version: v1
    - name: canary
      labels:
        version: canary

---
# Destination Rule for Data Management Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: dsr-data-management-dr
  namespace: dsr-production
spec:
  host: dsr-data-management-service
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 150
        connectTimeout: 30s
        keepAlive:
          time: 7200s
          interval: 75s
      http:
        http1MaxPendingRequests: 75
        http2MaxRequests: 150
        maxRequestsPerConnection: 15
        maxRetries: 3
    circuitBreaker:
      consecutiveGatewayErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50

---
# Destination Rule for Payment Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: dsr-payment-dr
  namespace: dsr-production
spec:
  host: dsr-payment-service
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    connectionPool:
      tcp:
        maxConnections: 80
        connectTimeout: 30s
        keepAlive:
          time: 7200s
          interval: 75s
      http:
        http1MaxPendingRequests: 40
        http2MaxRequests: 80
        maxRequestsPerConnection: 8
        maxRetries: 2
    circuitBreaker:
      consecutiveGatewayErrors: 3
      interval: 30s
      baseEjectionTime: 60s
      maxEjectionPercent: 30
      minHealthPercent: 70

---
# Service Entry for External Dependencies
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: dsr-external-services
  namespace: dsr-production
spec:
  hosts:
    - philsys.gov.ph
    - bangkosentral.gov.ph
    - landbank.com
  ports:
    - number: 443
      name: https
      protocol: HTTPS
    - number: 80
      name: http
      protocol: HTTP
  location: MESH_EXTERNAL
  resolution: DNS

---
# Authorization Policy for API Security
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: dsr-api-authz
  namespace: dsr-production
spec:
  selector:
    matchLabels:
      tier: backend
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/dsr-production/sa/dsr-frontend"]
        - source:
            namespaces: ["dsr-production"]
      to:
        - operation:
            methods: ["GET", "POST", "PUT", "DELETE"]
            paths: ["/api/v1/*"]
      when:
        - key: request.headers[authorization]
          values: ["Bearer *"]

---
# Peer Authentication for mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: dsr-mtls
  namespace: dsr-production
spec:
  mtls:
    mode: STRICT

---
# Telemetry Configuration for Observability
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: dsr-telemetry
  namespace: dsr-production
spec:
  metrics:
    - providers:
        - name: prometheus
    - overrides:
        - match:
            metric: ALL_METRICS
          tagOverrides:
            request_protocol:
              value: "http"
        - match:
            metric: REQUEST_COUNT
          disabled: false
        - match:
            metric: REQUEST_DURATION
          disabled: false
        - match:
            metric: REQUEST_SIZE
          disabled: false
        - match:
            metric: RESPONSE_SIZE
          disabled: false
  tracing:
    - providers:
        - name: jaeger
  accessLogging:
    - providers:
        - name: otel

---
# Envoy Filter for Rate Limiting
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: dsr-rate-limit
  namespace: dsr-production
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            value:
              stat_prefix: dsr_rate_limiter
              token_bucket:
                max_tokens: 100
                tokens_per_fill: 100
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED

---
# Workload Entry for External Database
apiVersion: networking.istio.io/v1beta1
kind: WorkloadEntry
metadata:
  name: dsr-database
  namespace: dsr-production
spec:
  address: dsr-db-primary.internal
  ports:
    postgresql: 5432
  labels:
    app: postgresql
    version: "13"

---
# Sidecar Configuration for Resource Optimization
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: dsr-sidecar
  namespace: dsr-production
spec:
  workloadSelector:
    labels:
      tier: backend
  ingress:
    - port:
        number: 8080
        protocol: HTTP
        name: http
      defaultEndpoint: 127.0.0.1:8080
  egress:
    - hosts:
        - "./*"
        - "istio-system/*"
        - "dsr-infrastructure/*"
